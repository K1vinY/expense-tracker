<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Expense Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="title">ğŸ’° Pixel Expense Tracker</h1>
            <div class="balance-display">
                <span class="balance-label">Total Balance:</span>
                <span class="balance-amount" id="totalBalance">$0</span>
            </div>
        </header>

        <!-- Groups Overview Section -->
        <section class="groups-section">
            <div class="groups-container">
                <h2 class="section-title">ğŸ“ My Groups</h2>
                <div class="groups-grid" id="groupsGrid">
                    <!-- Groups will be dynamically inserted here -->
                </div>
                <button id="addGroupBtn" class="pixel-button primary add-group-btn">â• Add New Group</button>
            </div>
        </section>

        <!-- Group Member Management Section (Hidden by default) -->
        <section class="group-members-section" id="groupMembersSection" style="display: none;">
            <div class="group-members-container">
                <div class="group-header">
                    <button id="backFromMembers" class="pixel-button secondary">â† Back to Transactions</button>
                    <h2 class="group-title" id="membersGroupTitle">Group Members</h2>
                    <div class="member-count" id="memberCount">0 members</div>
                </div>

                <!-- Members List -->
                <div class="list-container">
                    <h3 class="section-title">ğŸ“‹ Group Members</h3>
                    <div id="membersList" class="members-list">
                        <!-- Members will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Add Member Form -->
                <div class="form-container">
                    <h3 class="section-title">ğŸ‘¥ Add New Member</h3>
                    <form id="addMemberForm" class="pixel-form">
                        <div class="form-group">
                            <label for="memberName">Member Name:</label>
                            <input type="text" id="memberName" placeholder="e.g. John Doe" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="memberRole">Role:</label>
                            <select id="memberRole">
                                <option value="member">ğŸ‘¤ Member</option>
                                <option value="admin">ğŸ‘‘ Admin</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="pixel-button primary">â• Add Member</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Group Settings Section (Hidden by default) -->
        <section class="group-settings-section" id="groupSettingsSection" style="display: none;">
            <div class="group-settings-container">
                <div class="group-header">
                    <button id="backFromSettings" class="pixel-button secondary">â† Back to Transactions</button>
                    <h2 class="group-title" id="settingsGroupTitle">Group Settings</h2>
                    <div class="settings-status" id="settingsStatus">Active</div>
                </div>

                <!-- Group Information -->
            <div class="form-container">
                    <h3 class="section-title">ğŸ“ Group Information</h3>
                    <form id="groupInfoForm" class="pixel-form">
                    <div class="form-group">
                            <label for="groupNameEdit">Group Name:</label>
                            <input type="text" id="groupNameEdit" placeholder="Enter group name" required>
                    </div>
                    
                    <div class="form-group">
                            <label for="groupDescription">Description (optional):</label>
                            <textarea id="groupDescription" placeholder="Enter group description" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" class="pixel-button primary">ğŸ’¾ Save Changes</button>
                    </form>
                </div>

                <!-- Privacy Settings -->
                <div class="list-container">
                    <h3 class="section-title">ğŸ”’ Privacy Settings</h3>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Group Visibility</div>
                                <div class="setting-desc">Who can see this group</div>
                            </div>
                            <select id="groupVisibility" class="pixel-select">
                                <option value="public">ğŸŒ Public</option>
                                <option value="private">ğŸ”’ Private</option>
                            </select>
                    </div>
                    
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Member Invitations</div>
                                <div class="setting-desc">Who can invite new members</div>
                            </div>
                            <select id="invitePermission" class="pixel-select">
                                <option value="admin">ğŸ‘‘ Admins only</option>
                                <option value="all">ğŸ‘¥ All members</option>
                        </select>
                        </div>
                    </div>
                    </div>
                    
                <!-- Notification Settings -->
                <div class="stats-container">
                    <h3 class="section-title">ğŸ“§ Notification Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-icon">ğŸ’°</div>
                            <div class="setting-label">New Transactions</div>
                            <div class="setting-value">Enabled</div>
                        </div>
                        <div class="setting-card">
                            <div class="setting-icon">ğŸ‘¥</div>
                            <div class="setting-label">New Members</div>
                            <div class="setting-value">Enabled</div>
                        </div>
                        <div class="setting-card">
                            <div class="setting-icon">ğŸ“Š</div>
                            <div class="setting-label">Weekly Reports</div>
                            <div class="setting-value">Disabled</div>
                        </div>
                        </div>
                    </div>
                    
                <!-- Danger Zone -->
                <div class="stats-container danger-zone">
                    <h3 class="section-title">âš ï¸ Danger Zone</h3>
                    <div class="danger-actions">
                        <button id="deleteGroup" class="pixel-button danger">ğŸ—‘ï¸ Delete Group</button>
                        <button id="leaveGroup" class="pixel-button danger">ğŸ‘‹ Leave Group</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Group Detail Section (Hidden by default) -->
        <section class="group-detail-section" id="groupDetailSection" style="display: none;">
            <div class="group-detail-container">
                <div class="group-header">
                    <button id="backToGroups" class="pixel-button secondary">â† Back to Groups</button>
                    <h2 class="group-title" id="groupTitle">Group Transactions</h2>
                    <div class="group-balance" id="groupBalance">$0</div>
                </div>

                <!-- Group Actions -->
                <div class="group-actions">
                    <button id="manageMembers" class="pixel-button secondary">ğŸ‘¥ Manage Members</button>
                    <button id="groupSettings" class="pixel-button secondary">âš™ï¸ Settings</button>
                </div>

                <!-- Expense Form -->
                <div class="form-container">
                    <h3 class="section-title">ğŸ“ Add Transaction</h3>
                    <form id="expenseForm" class="pixel-form">
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <input type="text" id="description" placeholder="e.g. Lunch" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="amount">Amount:</label>
                            <input type="number" id="amount" placeholder="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="transactionDate">Date & Time:</label>
                            <input type="datetime-local" id="transactionDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="paidBy">Paid by:</label>
                            <select id="paidBy" required>
                                <option value="">Select who paid</option>
                    </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="splitBy">Split by:</label>
                            <div id="splitByContainer" class="split-container">
                                <!-- Split options will be dynamically inserted here -->
                            </div>
                        </div>
                        
                        <button type="submit" class="pixel-button primary">ğŸ’¾ Save</button>
                    </form>
                </div>

                <!-- Transaction List -->
                <div class="list-container">
                    <h3 class="section-title">ğŸ“‹ Transactions</h3>
                    <div class="filter-controls">
                        <button id="clearAll" class="pixel-button danger">ğŸ—‘ï¸ Clear All</button>
                </div>
                <div id="expenseList" class="expense-list">
                        <!-- Transaction items will be dynamically inserted here -->
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Firebase SDK (æš«æ™‚è¨»è§£ï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script> -->

    <script>
        // æš«æ™‚ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬é€²è¡Œæ¸¬è©¦
        // ç•¶æ‚¨è¨­å®šå¥½ Firebase å¾Œï¼Œè«‹å–æ¶ˆè¨»è§£ä¸Šé¢çš„ Firebase SDK ä¸¦è¨»è§£ä¸‹é¢çš„æœ¬åœ°ç‰ˆæœ¬
        
        // æœ¬åœ°ç‰ˆæœ¬ - ä½¿ç”¨ localStorage
        const isLocalMode = true; // è¨­å®šç‚º false ç•¶æ‚¨è¦ä½¿ç”¨ Firebase æ™‚

        // Group-based Expense Tracker (æ”¯æ´æœ¬åœ°å’Œ Firebase æ¨¡å¼)
        class GroupExpenseTracker {
            constructor() {
                this.groups = [];
                this.currentGroupId = null;
                this.init();
            }
            
            init() {
                this.loadGroups();
                this.bindEvents();
            }
            
            async loadGroups() {
                if (isLocalMode) {
                    // æœ¬åœ°æ¨¡å¼
                    this.groups = JSON.parse(localStorage.getItem('groups')) || [];
                    this.renderGroups();
                    this.updateTotalBalance();
                } else {
                    // Firebase æ¨¡å¼
                    try {
                        const snapshot = await db.collection('groups').orderBy('createdAt', 'desc').get();
                        this.groups = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        this.renderGroups();
                        this.updateTotalBalance();
                    } catch (error) {
                        console.error('Error loading groups:', error);
                        this.groups = [];
                        this.renderGroups();
                    }
                }
            }
            
            bindEvents() {
                // Group management
                document.getElementById('addGroupBtn').addEventListener('click', () => {
                    this.addGroup();
                });
                
                document.getElementById('backToGroups').addEventListener('click', () => {
                    this.showGroupsView();
                });
                
                document.getElementById('backFromMembers').addEventListener('click', () => {
                    this.showGroupDetail(this.currentGroupId);
                });
                
                // Member management
                document.getElementById('addMemberForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addMember();
                });
                
                document.getElementById('manageMembers').addEventListener('click', () => {
                    this.showGroupMembers(this.currentGroupId);
                });
                
                document.getElementById('groupSettings').addEventListener('click', () => {
                    this.showGroupSettings(this.currentGroupId);
                });
                
                document.getElementById('backFromSettings').addEventListener('click', () => {
                    this.showGroupDetail(this.currentGroupId);
                });
                
                document.getElementById('groupInfoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateGroupInfo();
                });
                
                document.getElementById('deleteGroup').addEventListener('click', () => {
                    this.deleteGroup();
                });
                
                document.getElementById('leaveGroup').addEventListener('click', () => {
                    this.leaveGroup();
                });
                
                // Expense management
                document.getElementById('expenseForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addExpense();
                });
                
                document.getElementById('clearAll').addEventListener('click', () => {
                    this.clearAllExpenses();
                });
            }
            
            async addGroup() {
                const groupName = prompt('Enter group name:');
                if (!groupName) return;
                
                // å‰µå»ºç¾¤çµ„å¾Œç›´æ¥é€²å…¥æˆå“¡ç®¡ç†é é¢
                const group = {
                    id: Date.now().toString(),
                    name: groupName,
                    expenses: [],
                    members: [
                        {
                            id: Date.now().toString(),
                            name: 'You',
                            role: 'admin',
                            joinedAt: new Date().toISOString()
                        }
                    ],
                    createdAt: new Date().toISOString()
                };
                
                this.groups.unshift(group);
                this.saveGroups();
                this.renderGroups();
                
                // ç›´æ¥é€²å…¥æˆå“¡ç®¡ç†é é¢
                this.showGroupMembers(group.id);
            }
            
            showGroupMembers(groupId) {
                this.currentGroupId = groupId;
                const group = this.groups.find(g => g.id === groupId);
                
                document.getElementById('membersGroupTitle').textContent = `${group.name} - Members`;
                document.getElementById('memberCount').textContent = `${group.members.length} members`;
                document.getElementById('groupMembersSection').style.display = 'block';
                document.querySelector('.groups-section').style.display = 'none';
                document.getElementById('groupDetailSection').style.display = 'none';
                document.getElementById('groupSettingsSection').style.display = 'none';
                
                this.renderMembers();
            }
            
            showGroupDetail(groupId) {
                this.currentGroupId = groupId;
                const group = this.groups.find(g => g.id === groupId);
                
                document.getElementById('groupTitle').textContent = `${group.name} - Transactions`;
                document.getElementById('groupDetailSection').style.display = 'block';
                document.querySelector('.groups-section').style.display = 'none';
                document.getElementById('groupMembersSection').style.display = 'none';
                document.getElementById('groupSettingsSection').style.display = 'none';
                
                this.loadGroupMembers();
                this.renderExpenses();
                this.updateGroupStats();
            }
            
            showGroupSettings(groupId) {
                this.currentGroupId = groupId;
                const group = this.groups.find(g => g.id === groupId);
                
                document.getElementById('settingsGroupTitle').textContent = `${group.name} - Settings`;
                document.getElementById('groupSettingsSection').style.display = 'block';
                document.querySelector('.groups-section').style.display = 'none';
                document.getElementById('groupDetailSection').style.display = 'none';
                document.getElementById('groupMembersSection').style.display = 'none';
                
                // è¼‰å…¥ç¾¤çµ„è³‡è¨Šåˆ°è¡¨å–®
                document.getElementById('groupNameEdit').value = group.name;
                document.getElementById('groupDescription').value = group.description || '';
                document.getElementById('groupVisibility').value = group.visibility || 'public';
                document.getElementById('invitePermission').value = group.invitePermission || 'admin';
            }
            
            showGroupsView() {
                document.getElementById('groupDetailSection').style.display = 'none';
                document.getElementById('groupMembersSection').style.display = 'none';
                document.getElementById('groupSettingsSection').style.display = 'none';
                document.querySelector('.groups-section').style.display = 'block';
                this.currentGroupId = null;
                this.updateTotalBalance();
            }
            
            async addExpense() {
                if (!this.currentGroupId) {
                    console.log('No current group ID');
                    return;
                }
                
                const description = document.getElementById('description').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const transactionDate = document.getElementById('transactionDate').value;
                const paidBy = document.getElementById('paidBy').value;
                
                console.log('Form data:', { description, amount, transactionDate, paidBy });
                
                if (!description || !amount || !paidBy) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                // ç²å–åˆ†éŒ¢çš„æˆå“¡
                const splitBy = this.getSplitByMembers();
                console.log('Split by members:', splitBy);
                
                if (splitBy.length === 0) {
                    alert('Please select at least one person to split the cost with.');
                    return;
                }
                
                const expense = {
                    description,
                    amount: Math.abs(amount), // åªå„²å­˜æ­£æ•¸
                    paidBy,
                    splitBy,
                    date: new Date(transactionDate).toISOString(),
                    timestamp: Date.now()
                };
                
                console.log('New expense:', expense);
                
                if (isLocalMode) {
                    // æœ¬åœ°æ¨¡å¼
                    const group = this.groups.find(g => g.id === this.currentGroupId);
                    group.expenses.push(expense);
                    this.saveGroups();
                    this.renderExpenses();
                    this.updateGroupStats();
                    this.updateTotalBalance();
                    this.resetForm();
                    console.log('Expense added successfully');
                } else {
                    // Firebase æ¨¡å¼
                    try {
                        await db.collection('groups').doc(this.currentGroupId).update({
                            expenses: firebase.firestore.FieldValue.arrayUnion(expense)
                        });
                        
                        // Update local data
                        const group = this.groups.find(g => g.id === this.currentGroupId);
                        group.expenses.push(expense);
                        
                        this.renderExpenses();
                        this.updateGroupStats();
                        this.updateTotalBalance();
                        this.resetForm();
                    } catch (error) {
                        console.error('Error adding expense:', error);
                        alert('Failed to add expense. Please try again.');
                    }
                }
            }
            
            async deleteExpense(timestamp) {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const expenseToDelete = group.expenses.find(expense => expense.timestamp === timestamp);
                
                if (!expenseToDelete) return;
                
                if (isLocalMode) {
                    // æœ¬åœ°æ¨¡å¼
                    group.expenses = group.expenses.filter(expense => expense.timestamp !== timestamp);
                    this.saveGroups();
                    this.renderExpenses();
                    this.updateGroupStats();
                    this.updateTotalBalance();
                } else {
                    // Firebase æ¨¡å¼
                    try {
                        await db.collection('groups').doc(this.currentGroupId).update({
                            expenses: firebase.firestore.FieldValue.arrayRemove(expenseToDelete)
                        });
                        
                        // Update local data
                        group.expenses = group.expenses.filter(expense => expense.timestamp !== timestamp);
                        
                this.renderExpenses();
                        this.updateGroupStats();
                        this.updateTotalBalance();
                    } catch (error) {
                        console.error('Error deleting expense:', error);
                        alert('Failed to delete expense. Please try again.');
                    }
                }
            }
            
            async clearAllExpenses() {
                if (!confirm('Are you sure you want to clear all transactions in this group?')) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                
                if (isLocalMode) {
                    // æœ¬åœ°æ¨¡å¼
                    group.expenses = [];
                    this.saveGroups();
                    this.renderExpenses();
                    this.updateGroupStats();
                    this.updateTotalBalance();
                } else {
                    // Firebase æ¨¡å¼
                    try {
                        await db.collection('groups').doc(this.currentGroupId).update({
                            expenses: []
                        });
                        
                        // Update local data
                        group.expenses = [];
                        
                        this.renderExpenses();
                        this.updateGroupStats();
                        this.updateTotalBalance();
                    } catch (error) {
                        console.error('Error clearing expenses:', error);
                        alert('Failed to clear expenses. Please try again.');
                    }
                }
            }
            
            saveGroups() {
                if (isLocalMode) {
                    localStorage.setItem('groups', JSON.stringify(this.groups));
                }
            }
            
            addMember() {
                const memberName = document.getElementById('memberName').value;
                const memberRole = document.getElementById('memberRole').value;
                
                if (!memberName) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const member = {
                    id: Date.now().toString(),
                    name: memberName,
                    role: memberRole,
                    joinedAt: new Date().toISOString()
                };
                
                group.members.push(member);
                this.saveGroups();
                this.renderMembers();
                this.updateMemberCount();
                this.resetMemberForm();
            }
            
            removeMember(memberId) {
                if (!confirm('Are you sure you want to remove this member?')) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                group.members = group.members.filter(member => member.id !== memberId);
                
                this.saveGroups();
                this.renderMembers();
                this.updateMemberCount();
            }
            
            renderMembers() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const list = document.getElementById('membersList');
                
                if (group.members.length === 0) {
                    list.innerHTML = '<div class="no-data">ğŸ‘¥ No members yet</div>';
                    return;
                }
                
                list.innerHTML = group.members.map(member => this.createMemberItem(member)).join('');
            }
            
            createMemberItem(member) {
                const roleIcon = member.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
                const roleClass = member.role === 'admin' ? 'admin' : 'member';
                
                return `
                    <div class="member-item">
                        <div class="member-info">
                            <div class="member-name">${roleIcon} ${member.name}</div>
                            <div class="member-role ${roleClass}">${member.role}</div>
                            <div class="member-joined">Joined: ${new Date(member.joinedAt).toLocaleDateString('en-US')}</div>
                        </div>
                        <button class="delete-btn" onclick="expenseTracker.removeMember('${member.id}')">âŒ</button>
                    </div>
                `;
            }
            
            updateMemberCount() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                document.getElementById('memberCount').textContent = `${group.members.length} members`;
            }
            
            resetMemberForm() {
                document.getElementById('addMemberForm').reset();
            }
            
            updateGroupInfo() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const newName = document.getElementById('groupNameEdit').value;
                const description = document.getElementById('groupDescription').value;
                const visibility = document.getElementById('groupVisibility').value;
                const invitePermission = document.getElementById('invitePermission').value;
                
                if (!newName) return;
                
                group.name = newName;
                group.description = description;
                group.visibility = visibility;
                group.invitePermission = invitePermission;
                
                this.saveGroups();
                this.renderGroups();
                
                // æ›´æ–°ç¾¤çµ„è©³æƒ…é é¢çš„æ¨™é¡Œ
                document.getElementById('groupTitle').textContent = newName;
                
                alert('Group information updated successfully!');
            }
            
            deleteGroup() {
                if (!this.currentGroupId) return;
                
                const groupName = this.groups.find(g => g.id === this.currentGroupId).name;
                
                if (!confirm(`Are you sure you want to delete the group "${groupName}"? This action cannot be undone!`)) {
                    return;
                }
                
                if (!confirm('This will permanently delete all transactions and members. Are you absolutely sure?')) {
                    return;
                }
                
                this.groups = this.groups.filter(g => g.id !== this.currentGroupId);
                this.saveGroups();
                this.renderGroups();
                this.showGroupsView();
                
                alert('Group deleted successfully!');
            }
            
            leaveGroup() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const groupName = group.name;
                
                if (!confirm(`Are you sure you want to leave the group "${groupName}"?`)) {
                    return;
                }
                
                // ç§»é™¤ç•¶å‰ç”¨æˆ¶ï¼ˆå‡è¨­æ˜¯ç¬¬ä¸€å€‹æˆå“¡ï¼‰
                if (group.members.length > 1) {
                    group.members = group.members.slice(1);
                    this.saveGroups();
                    this.renderGroups();
                    this.showGroupsView();
                    alert('You have left the group!');
                } else {
                    // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹æˆå“¡ï¼Œåˆªé™¤æ•´å€‹ç¾¤çµ„
                    this.deleteGroup();
                }
            }
            
            renderGroups() {
                const grid = document.getElementById('groupsGrid');
                
                if (this.groups.length === 0) {
                    grid.innerHTML = '<div class="no-data">ğŸ“ No groups yet. Create your first group!</div>';
                    return;
                }
                
                grid.innerHTML = this.groups.map(group => this.createGroupCard(group)).join('');
            }
            
            createGroupCard(group) {
                // è¨ˆç®—ç¸½é‡‘é¡ï¼ˆæ‰€æœ‰äº¤æ˜“çš„ç¸½å’Œï¼‰
                const totalAmount = group.expenses.reduce((sum, e) => sum + e.amount, 0);
                const memberCount = group.members ? group.members.length : 0;
                
                return `
                    <div class="group-card" onclick="expenseTracker.showGroupDetail('${group.id}')">
                        <div class="group-icon">ğŸ“</div>
                        <div class="group-name">${group.name}</div>
                        <div class="group-balance">$${totalAmount.toFixed(2)}</div>
                        <div class="group-transactions">${group.expenses.length} transactions</div>
                        <div class="group-members">ğŸ‘¥ ${memberCount} members</div>
                    </div>
                `;
            }
            
            renderExpenses() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const list = document.getElementById('expenseList');
                
                list.innerHTML = group.expenses.length === 0 
                    ? '<div class="no-data">ğŸ“ No transactions yet</div>'
                    : group.expenses.map(expense => this.createExpenseItem(expense)).join('');
            }
            
            createExpenseItem(expense) {
                // Handle both Firestore timestamp and regular date
                const date = expense.date && expense.date.toDate ? 
                    expense.date.toDate() : 
                    new Date(expense.date || expense.timestamp);
                
                // ç²å–ä»˜éŒ¢çš„äººå’Œåˆ†éŒ¢çš„äººçš„åç¨±
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const paidByName = group.members.find(m => m.id === expense.paidBy)?.name || 'Unknown';
                const splitByNames = expense.splitBy.map(id => 
                    group.members.find(m => m.id === id)?.name || 'Unknown'
                ).join(', ');
                
                return `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-description">${expense.description}</div>
                            <div class="expense-details">
                                <div class="expense-paid-by">ğŸ’° Paid by: ${paidByName}</div>
                                <div class="expense-split-by">ğŸ‘¥ Split by: ${splitByNames}</div>
                                <div class="expense-date">ğŸ“… ${date.toLocaleDateString('en-US')} ${date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                        </div>
                        <div class="expense-amount">
                            $${expense.amount.toFixed(2)}
                        </div>
                        <button class="delete-btn" onclick="expenseTracker.deleteExpense(${expense.timestamp})">âŒ</button>
                    </div>
                `;
            }
            
            
            updateGroupStats() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const totalAmount = group.expenses.reduce((sum, e) => sum + e.amount, 0);
                
                // åªæ›´æ–°ç¾¤çµ„é¤˜é¡é¡¯ç¤º
                document.getElementById('groupBalance').textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            updateTotalBalance() {
                const totalAmount = this.groups.reduce((total, group) => {
                    return total + group.expenses.reduce((sum, e) => sum + e.amount, 0);
                }, 0);
                
                document.getElementById('totalBalance').textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            
            resetForm() {
                document.getElementById('expenseForm').reset();
                // è¨­å®šé è¨­æ™‚é–“ç‚ºç¾åœ¨
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('transactionDate').value = localDateTime;
            }
            
            loadGroupMembers() {
                if (!this.currentGroupId) return;
                
                const group = this.groups.find(g => g.id === this.currentGroupId);
                const paidBySelect = document.getElementById('paidBy');
                const splitByContainer = document.getElementById('splitByContainer');
                
                // æ¸…ç©ºç¾æœ‰é¸é …
                paidBySelect.innerHTML = '<option value="">Select who paid</option>';
                splitByContainer.innerHTML = '';
                
                // æ·»åŠ æˆå“¡åˆ° Paid by ä¸‹æ‹‰é¸å–®
                group.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    paidBySelect.appendChild(option);
                });
                
                // å‰µå»º Split by é¸é …
                group.members.forEach(member => {
                    const splitItem = document.createElement('div');
                    splitItem.className = 'split-item';
                    splitItem.innerHTML = `
                        <label class="split-label">
                            <input type="checkbox" class="split-checkbox" value="${member.id}" checked>
                            <span class="split-custom"></span>
                            ${member.name}
                        </label>
                    `;
                    splitByContainer.appendChild(splitItem);
                });
            }
            
            getSplitByMembers() {
                const checkboxes = document.querySelectorAll('.split-checkbox:checked');
                return Array.from(checkboxes).map(checkbox => checkbox.value);
            }
        }
        
        // Initialize application
        const expenseTracker = new GroupExpenseTracker();
    </script>
</body>
</html>